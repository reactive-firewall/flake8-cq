C901: 'function' is too complex.

The function should be refactored into more modular functions.

See Also:
* https://flake8.pycqa.org/en/latest/user/error-codes.html
